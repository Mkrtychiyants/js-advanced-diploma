!function(){"use strict";class e{constructor(){this.boardSize=8,this.container=null,this.boardEl=null,this.cells=[],this.cellClickListeners=[],this.cellEnterListeners=[],this.cellLeaveListeners=[],this.newGameListeners=[],this.saveGameListeners=[],this.loadGameListeners=[]}bindToDOM(e){if(!(e instanceof HTMLElement))throw new Error("container is not HTMLElement");this.container=e}drawUi(e){this.checkBinding(),this.container.innerHTML='\n      <div class="controls">\n        <button data-id="action-restart" class="btn">New Game</button>\n        <button data-id="action-save" class="btn">Save Game</button>\n        <button data-id="action-load" class="btn">Load Game</button>\n      </div>\n      <div class="board-container">\n        <div data-id="board" class="board"></div>\n      </div>\n    ',this.newGameEl=this.container.querySelector("[data-id=action-restart]"),this.saveGameEl=this.container.querySelector("[data-id=action-save]"),this.loadGameEl=this.container.querySelector("[data-id=action-load]"),this.newGameEl.addEventListener("click",(e=>this.onNewGameClick(e))),this.saveGameEl.addEventListener("click",(e=>this.onSaveGameClick(e))),this.loadGameEl.addEventListener("click",(e=>this.onLoadGameClick(e))),this.boardEl=this.container.querySelector("[data-id=board]"),this.boardEl.classList.add(e);for(let e=0;e<this.boardSize**2;e+=1){const n=document.createElement("div");n.classList.add("cell","map-tile","map-tile-"+(t=e,a=this.boardSize,0===t?"top-left":t===a-1?"top-right":t===a*(a-1)?"bottom-left":t===a*a-1?"bottom-right":t%a==0?"left":t%a-(a-1)==0?"right":0===Math.floor(t/a)?"top":Math.floor(t/a)===a-1?"bottom":"center")),n.addEventListener("mouseenter",(e=>this.onCellEnter(e))),n.addEventListener("mouseleave",(e=>this.onCellLeave(e))),n.addEventListener("click",(e=>this.onCellClick(e))),this.boardEl.appendChild(n)}var t,a;this.cells=Array.from(this.boardEl.children)}redrawPositions(e){for(const e of this.cells)e.innerHTML="";for(const a of e){const e=this.boardEl.children[a.position],n=document.createElement("div");n.classList.add("character",a.character.type);const s=document.createElement("div");s.classList.add("health-level");const l=document.createElement("div");l.classList.add("health-level-indicator","health-level-indicator-"+((t=a.character.health)<15?"critical":t<50?"normal":"high")),l.style.width=`${a.character.health}%`,s.appendChild(l),n.appendChild(s),e.appendChild(n)}var t}addCellEnterListener(e){this.cellEnterListeners.push(e)}addCellLeaveListener(e){this.cellLeaveListeners.push(e)}addCellClickListener(e){this.cellClickListeners.push(e)}addNewGameListener(e){this.newGameListeners.push(e)}addSaveGameListener(e){this.saveGameListeners.push(e)}addLoadGameListener(e){this.loadGameListeners.push(e)}onCellEnter(e){e.preventDefault();const t=this.cells.indexOf(e.currentTarget);this.cellEnterListeners.forEach((e=>e.call(null,t)))}onCellLeave(e){e.preventDefault();const t=this.cells.indexOf(e.currentTarget);this.cellLeaveListeners.forEach((e=>e.call(null,t)))}onCellClick(e){const t=this.cells.indexOf(e.currentTarget);this.cellClickListeners.forEach((e=>e.call(null,t)))}onNewGameClick(e){e.preventDefault(),this.newGameListeners.forEach((e=>e.call(null)))}onSaveGameClick(e){e.preventDefault(),this.saveGameListeners.forEach((e=>e.call(null)))}onLoadGameClick(e){e.preventDefault(),this.loadGameListeners.forEach((e=>e.call(null)))}static showError(e){alert(e)}static showMessage(e){alert(e)}selectCell(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"yellow";this.deselectCell(e),this.cells[e].classList.add("selected",`selected-${t}`)}deselectCell(e){const t=this.cells[e];t.classList.remove(...Array.from(t.classList).filter((e=>e.startsWith("selected"))))}showCellTooltip(e,t){this.cells[t].title=e}hideCellTooltip(e){this.cells[e].title=""}showDamage(e,t){return new Promise((a=>{const n=this.cells[e],s=document.createElement("span");s.textContent=t,s.classList.add("damage"),n.appendChild(s),s.addEventListener("animationend",(()=>{n.removeChild(s),a()}))}))}setCursor(e){this.boardEl.style.cursor=e}checkBinding(){if(null===this.container)throw new Error("GamePlay not bind to DOM")}}class t{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"generic";if(this.level=e,this.attack=0,this.defence=0,this.health=50,this.type=t,"Character"===new.target.name)throw new Error("no new invokement")}}class a{constructor(e){try{this.characters=Array.from(e)}catch(e){throw new Error(e)}}}function*n(e,t){const a=Math.ceil(Math.random()*e.length-1),s=Math.ceil(Math.random()*t);yield new e[a](s),yield*n(e,t)}function s(e,t,s){const l=[],i=n(e,t);for(let e=0;e<s;e+=1)l.push(i.next().value);return new a(l)}class l{constructor(e,a){if(!(e instanceof t))throw new Error("character must be instance of Character or its children");if("number"!=typeof a)throw new Error("position must be a number");this.character=e,this.position=a}}class i{static from(e){return this.activeGame={...e},null}static getGame(){return this.activeGame}}var r="pointer",c="crosshair",o="not-allowed",h={prairie:"prairie",desert:"desert",arctic:"arctic",mountain:"mountain"};const d=[class extends t{constructor(e){super(e),this.type="swordsman",this.attack=40,this.defence=10}},class extends t{constructor(e){super(e),this.type="bowman",this.attack=25,this.defence=25}},class extends t{constructor(e){super(e),this.type="magician",this.attack=10,this.defence=40}}],m=[class extends t{constructor(e){super(e),this.type="undead",this.attack=40,this.defence=10}},class extends t{constructor(e){super(e),this.type="vampire",this.attack=25,this.defence=25}},class extends t{constructor(e){super(e),this.type="daemon",this.attack=10,this.defence=10}}],u=[],f=[],g=[],p=[],v=[],C=[];let y,b,w,L,E,P,k=!0,G=0,M=0;function S(e,t,a){t.includes(e[a])?S(e,t,Math.ceil(Math.random()*(e.length-1))):t.push(e[a])}function x(e,t){return`🎖 ${t.level} ⚔ ${t.attack} 🛡 ${t.defence} ❤ ${t.health}`}function O(e){e.gamePlay.redrawPositions(y)}function T(){return y=v.concat(...C),y}function D(e,t){return e.find((e=>e.position===t))}function N(t,a){let n=D(v,t);n?(b&&a.gamePlay.deselectCell(b),a.gamePlay.selectCell(t),b=t,L=D(T(),t)):(n=D(C,t),n&&!b&&e.showError("Not a player"))}function I(){return k=!!k,k}function $(e,t,a){T(),function(e){T().map((t=>{if(t.character.health<=0){let a=C.findIndex((e=>e===t));-1!==a?(C.splice(a,1),G+=1):(a=v.findIndex((e=>e===t)),v.splice(a,1)),O(e)}})),0===C.length&&(v.map((e=>{e.character.health<=20?e.character.health+=80:e.character.health=100,e.character.level<=3&&(e.character.level+=1),e.character.attack=Math.max(e.character.attack,e.character.attack*((80+e.character.health)/100)),e.character.defence=Math.max(e.character.defence,e.character.defence*((80+e.character.health)/100))})),function(e){const t=z(v,C,e);new H(t,e.stateService).init.call(e,e.gamePlay.drawUi(U(M,A(h),e)))}(e),M+=1,U(M,A(h),this))}(a),0!==e.length&&4!==M||function(e){e.gamePlay.boardEl.onCellClick=null,e.gamePlay.boardEl.onCellEnter=null,e.gamePlay.boardEl.onCellLeave=null}(a),I(),function(e){k&&(w=C[Math.floor(Math.random()*C.length)],function(e,t){const a=function(e,t){const a=new Set;for(let n=1;n<=t;n+=1){const t=e-7*n,s=e+7*n;for(let e=0;e<2*n+1;e+=1)a.add(Math.abs(t+8*e)),a.add(Math.abs(t-e)),a.add(Math.abs(s-8*e)),a.add(Math.abs(s+e))}return Array.from(a)}(e.position,q(e.character)),n=v.filter((e=>a.includes(e.position)));if(n[0]){const a=n[0].character,s=Math.max(e.character.attack-a.defence,.1*e.character.attack);t.gamePlay.showDamage(n[0].position,s).then((()=>{a.health-=s,T(),O(t)})).catch((e=>{console.log(e)}))}else{const a=function(e,t){const a=new Set;for(let n=1;n<=t;n+=1)a.add(e+7*n),a.add(e-7*n),a.add(e+8*n),a.add(e-9*n),a.add(e+n),a.add(e-n);return Array.from(a)}(e.position,j(e.character)),n=a[Math.floor(Math.random()*(a.length-1))];if(T(),!D(n)){const a=C.findIndex((t=>t.position===e.position));C.splice(a,1,new l(e.character,n)),e.position=n,T(),O(t)}}}(w,e),function(e,t){if(w)for(let e=0;e<C.length;e+=1){const a=C[e];t.gamePlay.deselectCell(a.position)}t.gamePlay.selectCell(e.position,"green")}(w,e))}(a),z(e,t,a),I()}function j(e){switch(e.type){case"bowman":case"vampire":return 2;case"swordsman":case"undead":return 4;default:return 1}}function q(e){switch(e.type){case"bowman":case"vampire":return 2;case"swordsman":case"undead":return 1;default:return 4}}function A(e){return Object.values(e)}function U(e,t,a){const n=z(v,C,a);if(e<t.length)return t[n.n+=1];U(e=0,t,a)}function z(t,a,n){Object.defineProperty(n.gamePlay,"team1",{value:t,writable:!0,enumerable:!0,configurable:!0}),Object.defineProperty(n.gamePlay,"team2",{value:a,writable:!0,enumerable:!0,configurable:!0}),Object.defineProperty(n.gamePlay,"points",{value:G,writable:!0,enumerable:!0,configurable:!0}),Object.defineProperty(n.gamePlay,"nextMove",{value:k,writable:!0,enumerable:!0,configurable:!0}),Object.defineProperty(n.gamePlay,"nextLevel",{value:M,writable:!0,enumerable:!0,configurable:!0}),i.from(n.gamePlay);const s=i.getGame();n.stateService.save(s);try{return n.stateService.load()}catch(t){e.showError(t)}}class H{constructor(e,t){this.gamePlay=e,this.stateService=t}init(){const e=s(d,3,4),t=s(m,3,4),a=this.gamePlay.boardSize;for(let e=0;e<a*a;e+=1)e%a==0&&u.push(e),e%a-1==0&&u.push(e),e%a-(a-1)==0&&f.push(e),e%a-(a-2)==0&&f.push(e);for(let a=0;a<e.characters.length;a+=1)S(u,g,Math.ceil(Math.random()*(u.length-1))),S(f,p,Math.ceil(Math.random()*(f.length-1))),v.push(new l(e.characters[a],g[a])),C.push(new l(t.characters[a],p[a]));T(),O(this),this.gamePlay.boardEl.onCellEnter=this.gamePlay.addCellEnterListener(this.onCellEnter.bind(this)),this.gamePlay.boardEl.onCellLeave=this.gamePlay.addCellLeaveListener(this.onCellLeave.bind(this)),this.gamePlay.boardEl.onCellClick=this.gamePlay.addCellClickListener(this.onCellClick.bind(this)),this.gamePlay.newGameEl.onCellClick=this.gamePlay.addNewGameListener(this.onNewGameClick.bind(this)),this.gamePlay.saveGameEl.onCellClick=this.gamePlay.addSaveGameListener(this.onSaveGameClick.bind(this)),this.gamePlay.loadGameEl.onCellClick=this.gamePlay.addLoadGameListener(this.onLoadGameClick.bind(this))}onCellClick(e){var t,a,n;t=e,a=this,n?console.log("Not your move!"):(N(t,a),function(e,t){const a=D(v,e);if(E&&!a){const a=v.findIndex((e=>e.position===b));v.splice(a,1,new l(L.character,e)),O(t),N(e,t),$(v,C,t)}else console.log("Cell is occupied")}(t,a),function(e,t){if(P){const a=D(C,e).character,n=Math.max(L.character.attack-a.defence,.1*L.character.attack);t.gamePlay.showDamage(e,n).then((()=>{a.health-=n,t.gamePlay.redrawPositions(v.concat(...C)),$(v,C,t)})).catch((e=>{console.log(e)}))}}(t,a))}onNewGameClick(){const e=z(v,C,this);new H(e,this.stateService).init.call(this,this.gamePlay.drawUi(U(M,A(h),this)))}onSaveGameClick(){z(v,C,this)}onLoadGameClick(){const e=z(v,C,this);new H(e,this.stateService).init.call(this,this.gamePlay.drawUi(U(M,A(h),this)))}onCellEnter(e){const t=D(T(),e),a=D(v,e),n=D(C,e);if(t){const n=x`${t.character}`;this.gamePlay.showCellTooltip(n,e),a&&this.gamePlay.setCursor(r)}else this.gamePlay.setCursor(o);if(b&&b!==e){const a=j(L.character),l=q(L.character);s=e,this,t?E=!1:function(e,t,a){for(let n=1;n<=a;n+=1)if(7*n===Math.abs(e-t)||8*n===Math.abs(e-t)||9*n===Math.abs(e-t)||n===Math.abs(e-t))return!0;return!1}(b,s,a)&&(this.gamePlay.selectCell(s,"green"),this.gamePlay.setCursor(r),E=!0),function(e,t,a,s){n?function(e,t,a){for(let n=1;n<=a;n+=1){const a=e-7*n,s=e+7*n;for(let e=0;e<2*n+1;e+=1)if(t-a==8*e||a-t===e||t===s-8*e||t===s+e)return!0}return!1}(e,t,a)&&(s.gamePlay.selectCell(t,"red"),s.gamePlay.setCursor(c),P=!0):P=!1}(b,e,l,this)}var s}onCellLeave(e){this.gamePlay.hideCellTooltip(e),this.gamePlay.deselectCell(e),b&&this.gamePlay.selectCell(b)}}const B=new e;B.bindToDOM(document.querySelector("#game-container"));const J=new class{constructor(e){this.storage=e}save(e){this.storage.setItem("state",JSON.stringify(e))}load(){try{return JSON.parse(this.storage.getItem("state"))}catch(e){throw new Error("Invalid state")}}}(localStorage);new H(B,J).init(B.drawUi(h.prairie))}();